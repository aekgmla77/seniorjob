<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="com.company.mentoring_reviews.service.impl.Mentoring_ReviewsMapper">
	<select id="getMentoring_ReviewsList" resultType="Mentoring_ReviewsVO">
	select 
		seq,
		category_a,
		category_b,
		to_char(w_date, 'yyyy-mm-dd') as w_date,
		click,
		content,
		r_file,
		id,
		mentoring_number,
		title
		from mentoring_reviews
	</select>
	
	<select id="getMentoring_Reviews" resultType="Mentoring_ReviewsVO" parameterType="Mentoring_ReviewsVO">
	select seq,
	category_a,
	category_b,
	to_char(w_date, 'yyyy-mm-dd') as w_date,
	click,
	content,
	s_file,
	id,
	title from service_center
	 WHERE SEQ = #{seq} 
	 </select>
<!-- 후기 등록 SQL 문구 작성 페이지 ============================================================== -->

<!--후기 페이징 처리(1) 페이지 갯수 체크  -->
	<select id="listCount"  parameterType="MenSearchCriteria" resultType="int">
		SELECT COUNT(SEQ) 
		FROM MENTORING_REVIEWS
		WHERE 1=1 and CATEGORY_A='대분류' 
		<include refid="search"></include>
		AND SEQ > 0	  
	</select>
	
	<!--후기 검색 -->
	<sql id="search">
		<if test="searchType != null">
				<if test="searchType == 't'.toString()">AND TITLE LIKE '%' || #{keyword} || '%'</if>
				<if test="searchType == 'c'.toString()">AND CONTENT LIKE '%' || #{keyword} || '%'</if>
				<if test="searchType == 'w'.toString()">AND ID LIKE '%' || #{keyword} || '%'</if>
				<if test="searchType == 'tc'.toString()">AND (TITLE LIKE '%' || #{keyword} || '%') or (CONTENT LIKE '%' || #{keyword} || '%')</if>
		</if>
	</sql>
	
<!--후기 페이징 처리(2) 페이지 처리 후 게시글 조회  -->
	<select id="list" resultType="Mentoring_ReviewsVO" parameterType="Mentoring_ReviewsVO">
		SELECT 	SEQ,
				CATEGORY_A,
				CATEGORY_B,
				W_DATE,
				CLICK,
				CONTENT,
				R_FILE,
				ID,
				TITLE 
		FROM (SELECT 	    SEQ,
							CATEGORY_A,
						    CATEGORY_B,
							W_DATE,
						    CLICK,
							CONTENT,
							R_FILE,
							ID,
							TITLE, ROW_NUMBER() OVER(ORDER BY SEQ DESC) AS RNUM
							FROM MENTORING_REVIEWS
							where 1=1 and CATEGORY_A='대분류' 
							<include refid="search"></include>
							) MENTORING_REVIEWS WHERE RNUM
							BETWEEN #{rowStart} AND #{rowEnd}
							ORDER BY SEQ DESC

	</select>	
	
<!--공지사항 이전글, 다음글-->
<select id="menPreNext" resultType="Mentoring_ReviewsVO" parameterType="Mentoring_ReviewsVO">
	SELECT SEQ, MENPREV, MENPREV_TITLE, MENNEXT, MENNEXT_TITLE 
			FROM (
  					SELECT  SEQ, 
    						LAG(SEQ,1) OVER(ORDER BY SEQ) MENPREV,
						    LAG(TITLE,1) OVER(ORDER BY SEQ) MENPREV_TITLE,    
						    LEAD(SEQ,1) OVER(ORDER BY SEQ) MENNEXT, 
						    LEAD(TITLE,1) OVER(ORDER BY SEQ) MENNEXT_TITLE
 		FROM MENTORING_REVIEWS
 		WHERE CATEGORY_A='대분류' )
 		WHERE SEQ= #{seq}  
</select>	

<!-- 후기 단건조회 -->
<select id="getSearchMenReview" parameterType="Mentoring_ReviewsVO" resultType="Mentoring_ReviewsVO">
	SELECT SEQ, CATEGORY_A, CATEGORY_B, W_DATE,
	CLICK, CONTENT, R_FILE, ID, TITLE FROM MENTORING_REVIEWS
	WHERE SEQ = #{seq}  AND CATEGORY_A='대분류' 
</select>

<!-- 후기 등록 -->
<insert id="insertMenReview" parameterType="Mentoring_ReviewsVO">
	INSERT INTO MENTORING_REVIEWS(SEQ,
				CATEGORY_A,
				CATEGORY_B,
				W_DATE,
				CONTENT,
				CLICK,
				R_FILE,
				ID,
				MENTORING_NUMBER,
				TITLE) 
	values ((SELECT NVL(MAX(SEQ),0)+1 FROM mentoring_reviews),
				#{category_a},
				#{category_b}, 
				sysdate,
				#{content},
				'0',
				'파일없음',
				#{id},
				#{mentoring_number},
				#{title})			 				
</insert>

<!-- 후기 수정 -->
<update id="updateMenReview" parameterType="Mentoring_ReviewsVO"> 
 UPDATE MENTORING_REVIEWS SET
 			title = #{title},
 			content = #{content}
 WHERE SEQ = #{seq}	
</update>

<!-- 후기 삭제 -->
<delete id="deleteMenReview" parameterType="Mentoring_ReviewsVO">
	DELETE FROM MENTORING_REVIEWS 
				WHERE SEQ = #{seq}
</delete>

<!-- 후기 조회수 증가 -->
<update id="upnumMenReview" parameterType="Mentoring_ReviewsVO">
	UPDATE MENTORING_REVIEWS SET
		CLICK = NVL((CLICK),0)+1
		WHERE SEQ = #{seq}
</update>	
	
<!-- 인기 조회수 후기 페이지 띄우기 -->
<select id="pupMenUp" parameterType="Mentoring_ReviewsVO" resultType="Mentoring_ReviewsVO">
	UPDATE MENTORING_REVIEWS SET CLICK = CLICK + 1 WHERE SEQ = #{seq}
</select>	

<!-- 인기 조회수 후기 페이지 띄우기_김찬곤 -->
<!-- CDATA https://epthffh.tistory.com/entry/Mybatis-%EC%97%90%EC%84%9C-CDATA-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0 -->
	<select id="getPopularArticleList" resultType="Mentoring_ReviewsVO">
		<!-- SELECT A.MENTORING_KIND "mentoringVO.mentoring_kind" , B.*
			FROM 
				MENTORING A, MENTORING_REVIEWS B
			WHERE 
				A.MENTORING_NUMBER = B.MENTORING_NUMBER
			ORDER BY CLICK DESC -->
			
			SELECT * 
				FROM
					( SELECT * FROM MENTORING_REVIEWS ORDER BY CLICK DESC )
				WHERE 
					<![CDATA[ ROWNUM <= 3 ]]>
	</select>
	
	<!-- 송다희 추가 -->
	<!-- 멘토링 댓글 단건조회 -->
	<select id="getReviewsList" resultType="Mentoring_ReviewsVO">
	SELECT MENTORING_REVIEWS.SEQ, MENTORING_REVIEWS.W_DATE, MENTORING_REVIEWS.CONTENT, MENTORING_REVIEWS.ID, MENTORING_REVIEWS.MENTORING_NUMBER
	FROM MENTORING_REVIEWS MENTORING_REVIEWS, MENTORING MENTORING
	WHERE MENTORING_REVIEWS.MENTORING_NUMBER = MENTORING.MENTORING_NUMBER
	AND MENTORING_REVIEWS.MENTORING_NUMBER = #{mentoring_number}
	ORDER BY MENTORING_REVIEWS.SEQ
	</select>
 </mapper>