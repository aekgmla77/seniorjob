<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="com.company.mentoring_reviews.service.impl.Mentoring_ReviewsMapper">
	<!-- 후기 등록 SQL 문구 작성 페이지 ============================================================== -->

<!--후기 페이징 처리(1) 페이지 갯수 체크  -->
	<select id="listCount"  parameterType="MenSearchCriteria" resultType="int">
		SELECT COUNT(SEQ) 
		FROM MENTORING_REVIEWS
		WHERE 1=1 and CATEGORY_A='대분류' 
		<include refid="search"></include>
		AND SEQ > 0	  
	</select>
	
	<!--후기 검색 -->
	<sql id="search">
		<if test="searchType != null">
				<if test="searchType == 't'.toString()">AND TITLE LIKE '%' || #{keyword} || '%'</if>
				<if test="searchType == 'c'.toString()">AND CONTENT LIKE '%' || #{keyword} || '%'</if>
				<if test="searchType == 'w'.toString()">AND ID LIKE '%' || #{keyword} || '%'</if>
				<if test="searchType == 'tc'.toString()">AND (TITLE LIKE '%' || #{keyword} || '%') or (CONTENT LIKE '%' || #{keyword} || '%')</if>
		</if>
	</sql>
	
<!--후기 페이징 처리(2) 페이지 처리 후 게시글 조회  -->
	<select id="list" resultType="Mentoring_ReviewsVO" parameterType="Mentoring_ReviewsVO">
		SELECT 	SEQ,
				CATEGORY_A,
				CATEGORY_B,
				W_DATE,
				CLICK,
				CONTENT,
				R_FILE,
				ID,
				TITLE 
		FROM (SELECT 	    SEQ,
							CATEGORY_A,
						    CATEGORY_B,
							W_DATE,
						    CLICK,
							CONTENT,
							R_FILE,
							ID,
							TITLE, ROW_NUMBER() OVER(ORDER BY SEQ DESC) AS RNUM
							FROM MENTORING_REVIEWS
							where 1=1 and CATEGORY_A='대분류' 
							<include refid="search"></include>
							) MENTORING_REVIEWS WHERE RNUM
							BETWEEN #{rowStart} AND #{rowEnd}
							ORDER BY SEQ DESC

	</select>	
	
<!--공지사항 이전글, 다음글-->
<select id="preNext" resultType="Mentoring_ReviewsVO" parameterType="Mentoring_ReviewsVO">
	SELECT SEQ, MENPREV, MENPREV_TITLE, MENNEXT, MENNEXT_TITLE 
			FROM (
  					SELECT  SEQ, 
    						LAG(SEQ,1) OVER(ORDER BY SEQ) MENPREV,
						    LAG(TITLE,1) OVER(ORDER BY SEQ) MENPREV_TITLE,    
						    LEAD(SEQ,1) OVER(ORDER BY SEQ) MENNEXT, 
						    LEAD(TITLE,1) OVER(ORDER BY SEQ) MENNEXT_TITLE
 		FROM MENTORING_REVIEWS
 		WHERE CATEGORY_A='대분류' )
 		WHERE SEQ= #{seq}  
</select>	

<!-- 후기 단건조회 -->
<select id="getSearchMenReview" parameterType="Mentoring_ReviewsVO" resultType="Mentoring_ReviewsVO">
	SELECT SEQ, CATEGORY_A, CATEGORY_B, W_DATE,
	CLICK, CONTENT, R_FILE, ID, TITLE FROM MENTORING_REVIEWS
	WHERE SEQ = #{seq}  AND CATEGORY_A='대분류' 
</select>

<!-- 후기 등록 -->
<insert id="insertMenReview" parameterType="Mentoring_ReviewsVO">
	INSERT INTO MENTORING_REVIEWS(SEQ,
				CATEGORY_A,
				CATEGORY_B,
				W_DATE,
				CONTENT,
				CLICK,
				R_FILE,
				ID,
				MENTORING_NUMBER,
				TITLE) 
	values ((SELECT NVL(MAX(SEQ),0)+1 FROM mentoring_reviews),
				#{category_a},
				#{category_b}, 
				sysdate,
				#{content},
				'0',
				'파일없음',
				#{id},
				#{mentoring_number},
				#{title})			 				
</insert>

<!-- 후기 수정 -->
<update id="updateMenReview" parameterType="Mentoring_ReviewsVO"> 
 UPDATE MENTORING_REVIEWS SET
 			title = #{title},
 			content = #{content}
 WHERE SEQ = #{seq}	
</update>

<!-- 후기 삭제 -->
<delete id="deleteMenReview" parameterType="Mentoring_ReviewsVO">
	DELETE FROM MENTORING_REVIEWS 
				WHERE SEQ = #{seq}
</delete>

<!-- 후기 조회수 증가 -->
<update id="upnumMenReview" parameterType="Mentoring_ReviewsVO">
	UPDATE MENTORING_REVIEWS SET
		CLICK = NVL((CLICK),0)+1
		WHERE SEQ = #{seq}
</update>	
	
<!-- 인기 조회수 후기 페이지 띄우기 -->
<select id="pupMenUp" parameterType="Mentoring_ReviewsVO" resultType="Mentoring_ReviewsVO">
	UPDATE MENTORING_REVIEWS SET CLICK = CLICK + 1 WHERE SEQ = #{seq}
</select>	
	
 </mapper>